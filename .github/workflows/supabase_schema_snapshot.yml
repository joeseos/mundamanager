name: Supabase schema snapshot

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for manual run"
        required: false
        default: "Manual schema snapshot"
  schedule:
    - cron: "0 18 * * *"

# As we're using a deploy key doing the push, this permission does not matter and could be write or read
permissions:
  contents: write

concurrency:
  group: supabase-schema-snapshot
  cancel-in-progress: false

jobs:
  snapshot:
    runs-on: ubuntu-latest
    env:
      SUPABASE_SNAPSHOT_PATH: supabase/schema
      SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DB_URL }}

    steps:
      - name: Checkout (SSH via deploy key)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ssh-key: ${{ secrets.SUPABASE_DEPLOY_KEY }}

      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Dump public schema
        run: |
          set -euo pipefail

          mkdir -p "$SUPABASE_SNAPSHOT_PATH"

          tmpfile="$(mktemp)"

          pg_dump "$SUPABASE_DATABASE_URL" \
            --schema-only \
            --schema=public \
            --no-owner \
            --no-privileges \
            --format=plain \
            > "$tmpfile"

          mv "$tmpfile" "$SUPABASE_SNAPSHOT_PATH/schema.public.sql"

      - name: Commit if changed
        run: |
          set -euo pipefail

          git add "$SUPABASE_SNAPSHOT_PATH/schema.public.sql"

          if git diff --cached --quiet; then
            echo "No schema changes detected."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Make sure origin is SSH
          git remote set-url origin "git@github.com:${{ github.repository }}.git"

          git commit -m "chore(db): update Supabase schema snapshot"
          git push origin HEAD:main
