name: Supabase schema snapshot

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Reason for manual run"
        required: false
        default: "Manual schema snapshot"
  schedule:
    - cron: "0 18 * * *"

permissions:
  contents: write
  pull-requests: write

concurrency:
  group: supabase-schema-snapshot
  cancel-in-progress: false

jobs:
  snapshot:
    runs-on: ubuntu-latest
    env:
      SUPABASE_SNAPSHOT_PATH: supabase/schema
      SUPABASE_DATABASE_URL: ${{ secrets.SUPABASE_DB_URL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Dump public schema
        run: |
          set -euo pipefail

          mkdir -p "$SUPABASE_SNAPSHOT_PATH"

          tmpfile="$(mktemp)"

          pg_dump "$SUPABASE_DATABASE_URL" \
            --schema-only \
            --schema=public \
            --no-owner \
            --no-privileges \
            --format=plain \
            > "$tmpfile"

          mv "$tmpfile" "$SUPABASE_SNAPSHOT_PATH/schema.public.sql"

      - name: Create PR if changed
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail

          git add "$SUPABASE_SNAPSHOT_PATH/schema.public.sql"

          if git diff --cached --quiet; then
            echo "No Supabaseschema changes detected."
            exit 0
          fi

          BRANCH_NAME="chore/supabase-schema-snapshot-$(date +%Y%m%d)"

          # Check if a PR already exists for this branch
          EXISTING_PR=$(gh pr list --head "$BRANCH_NAME" --state open --json number --jq '.[0].number' || echo "")
          if [ -n "$EXISTING_PR" ]; then
            echo "PR #$EXISTING_PR already exists for branch $BRANCH_NAME. Updating it."
            git checkout -B "$BRANCH_NAME"
          else
            git checkout -b "$BRANCH_NAME"
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git commit -m "chore(db): update Supabase schema snapshot"
          git push -u origin "$BRANCH_NAME" --force

          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --title "chore(db): update Supabase schema snapshot" \
              --body "Automated schema snapshot update detected changes in the Supabase public schema." \
              --base main
          fi
